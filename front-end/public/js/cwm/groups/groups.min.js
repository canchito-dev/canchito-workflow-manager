/**
 * This content is released under the MIT License (MIT)
 *
 * Copyright (c) 2017, canchito-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 * @author 		Jose Carlos Mendoza Prego
 * @copyright	Copyright (c) 2017, canchito-dev (http://www.canchito-dev.com)
 * @license		http://opensource.org/licenses/MIT	MIT License
 * @link		https://github.com/canchito-dev/canchito-workflow-manager
 **/
$(document).ready(function(){Group.init(url);var e=$("#groups-grid-data").bootgrid({url:url+Group.getUrl("listOfGroups"),formatters:{commands:function(e,t){return'<button type="button" class="btn btn-sm btn-dark command-edit" data-row-id="'+t.id+'" data-toggle="tooltip" title="Edit"><span class="fas fa-edit"></span></button> <button type="button" class="btn btn-sm btn-dark command-delete" data-row-id="'+t.id+'" data-toggle="tooltip" title="Delete"><span class="fas fa-trash-alt"></span></button>'}},fieldHandler:function(e){return e.searchPhrase=$('form[name="formFilterGroup"]').serializeArray(),Group.requestFilter(e)},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><button type="button" class="btn btn-dark" id="btnNew" name="btnNew" data-toggle="tooltip" title="New"><i class="fas fa-plus" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnBatchDelete" name="btnBatchDelete" data-toggle="tooltip" title="Delete"><i class="fas fa-trash-alt" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnFilterSearch" name="btnFilterSearch" data-toggle="tooltip" title="Filter"><i class="fas fa-search" aria-hidden="true"></i></button>\x3c!--Your Button goes here--\x3e</div><p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){e.find(".command-edit").on("click",function(e){$('form[name="formGroup"]').find('input[name="action"]').val("update"),Group.edit($(this).data("row-id"),{success:function(e){if(e.code>=400)e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason);else{FormUtil.mapRestVariablesToForm($('form[name="formGroup"]'),[e.body]);var t=$('form[name="formGroup"]').find('input[name="id"]').val();t=t.split("@",1),$('form[name="formGroup"]').find('input[name="id"]').val(t);var o=$("#groupModal");o.find(".modal-title").text("Edit group"),o.modal("show")}}})}).end().find(".command-delete").on("click",function(t){var o=$(this).data("row-id");bootbox.confirm({title:"Delete group",message:'Do you really want to delete group with id "'+o+'"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(t){if(t)return Group.erase(o,{success:function(t){t.code>="400"?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success("Group successfully deleted"),e.bootgrid("reload"))}})}})})});$('button[name="btnNew"]').on("click",function(){$('form[name="formGroup"]').find('input[name="action"]').val("new");var e=$("#groupModal");e.find(".modal-title").text("New group"),e.modal("show")}),$('button[name="btnFilterSearch"]').on("click",function(){var e=$("#groupFilterSeachModal");e.find(".modal-title").text("Filter groups"),e.modal("show")}),$('button[name="btnBatchDelete"]').on("click",function(){bootbox.confirm({title:"Delete groups",message:'Do you really want to delete the selected groups"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(t){if(t){$("body").mLoading("show");var o=e.bootgrid("getSelectedRows"),a=[];$.each(o,function(e,t){a.push(Group.erase(t))}),$.when.apply(this,a).then(function(){var t=!1,o=[];$.each(a,function(e,a){a.responseJSON.code>="400"&&(t=!0,a.responseJSON.body.hasOwnProperty("exception")&&o.push(a.responseJSON.body.message+". "+a.responseJSON.body.exception+"<br>"))}),t?toastr.error(o):toastr.success("Selected groups successfully deleted"),e.bootgrid("reload"),$("body").mLoading("hide")})}}})}),$("#groupModal").on("show.bs.modal",function(e){if("update"==$('form[name="formGroup"]').find('input[name="action"]').val()){var o=$('form[name="formGroup"]').find('input[name="id"]');o.addClass("disabled"),o.attr("readonly",!0).attr("disabled",!0),$("#group-pills-tab a:eq(1)").removeClass("disabled"),t.bootgrid("reload")}}),$("#groupModal").on("hidden.bs.modal",function(e){$('form[name="formGroup"]').validate().resetForm(),$('form[name="formGroup"]').trigger("reset"),$('form[name="formGroup"]').find(".form-control").each(function(){$(this).removeClass("is-invalid")}),$('form[name="formGroup"]').find('input[name="action"]').val("new");var t=$('form[name="formGroup"]').find('input[name="id"]');t.removeClass("disabled"),t.attr("readonly",!1).attr("disabled",!1),$("#group-pills-tab li:first-child a").tab("show"),$("#group-pills-tab a:eq(1)").addClass("disabled")}),$('form[name="formGroup"]').validate({submitHandler:function(t){var o=$('form[name="formGroup"]').find('input[name="id"]');o.removeClass("disabled"),o.attr("readonly",!1).attr("disabled",!1),Group.save($(t).serializeArray(),{complete:function(){$("body").mLoading("hide")},success:function(t){t.code>=400?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success(t.reason),e.bootgrid("reload"),$("#groupModal").modal("hide"))}})}}),$('form[name="formFilterGroup"]').validate({submitHandler:function(t){e.bootgrid("reload"),$("#groupFilterSeachModal").modal("hide")}});var t=$("#users-grid-data").bootgrid({url:url+Group.getUrl("getMembers"),rowCount:[5,10,25,50,-1],formatters:{commands:function(e,t){return'<button type="button" class="btn btn-sm btn-dark command-unbind-user" data-row-id="'+t.id+'" data-toggle="tooltip" title="Unbind"><span class="fas fa-trash-alt"></span></button>'}},fieldHandler:function(e){return User.init(),(e=User.requestFilter(e)).memberOfGroup=$('form[name="formGroup"]').find('input[name="id"]').val(),e},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><select id="bindUser" name="bindUser" placeholder="Bind a user"></select><button type="button" class="btn btn-dark" id="btnBindUser" name="btnBindUser" data-toggle="tooltip" title="Bind user"><i class="fas fa-plus" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnBatchUnbindUser" name="btnBatchUnbindUser" data-toggle="tooltip" title="Unbind users"><i class="fas fa-trash-alt" aria-hidden="true"></i></button></div>\x3c!--Your Button goes here--\x3e<p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>',search:'<div class="{{css.search}} d-none"><div class="input-group"><span class="input-group-addon"><i class="{{css.icon}} {{css.iconSearch}}"></i></span> <input type="text" class="{{css.searchField}}" placeholder="{{lbl.search}}" /></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){t.find(".command-unbind-user").on("click",function(e){var o=$(this).data("row-id"),a=$('form[name="formGroup"]').find('input[name="id"]').val();bootbox.confirm({title:"Unbind user from group",message:'Do you really want to unbind user with id "'+o+'" from group "'+a+'"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(e){if(e)return Group.deleteMemberFromGroup(a,o,{success:function(e){e.code>="400"?(e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason)):(toastr.success("User successfully unbinded from group"),t.bootgrid("reload"))}})}})})});$('select[name="bindUser"]').selectize({valueField:"id",labelField:"firstName",searchField:"firstName",sortField:"firstName",inputClass:"selectize-form-control selectize-input",dropdownParent:"body",options:[],create:!1,persist:!1,loadThrottle:null,preload:!1,hideSelected:!0,render:{option:function(e,t){return'<option value="'+e.userId+'" data-data="'+JSON.stringify(e)+'">'+e.firstName+" "+e.lastName+"</option>"},item:function(e,t){return"<div>"+e.firstName+" "+e.lastName+"</div>"}},load:function(e,t){if(!e.length)return t();Ajax.executeAjax(url+User.getUrl("listOfUsers"),{firstNameLike:"%"+e+"%"},{type:"POST",dataType:"json",error:function(e){toastr.error("Could not load users"),console.log(e)},success:function(e){if(e.code>="400")return toastr.error("Could not load users"),!1;t(e.body.data.slice(0,15))}})},onChange:function(e){if(""!=e||void 0!=e||null!=e){var t=t=e.split("@",1);$('button[name="btnBindUser"]').data("user-id",t)}}}),$('button[name="btnBindUser"]').bind("click",function(){var e=$(this),o=$('form[name="formGroup"]').find('input[name="id"]').val(),a=e.data("userId")[0];Group.addMemberToGroup(o,a,{success:function(a){a.code>="400"?(a.body.hasOwnProperty("exception")&&(a.reason=a.body.message+". "+a.body.exception),toastr.error(a.reason)):(toastr.success('User successfully binded to group with id "'+o+'"'),t.bootgrid("reload"),e.removeData("user-id"),$('select[name="bindUser"]')[0].selectize.clear(!0))}})}),$('button[name="btnBatchUnbindUser"]').on("click",function(){var e=$('form[name="formGroup"]').find('input[name="id"]').val();bootbox.confirm({title:"Unbind users from group",message:'Do you really want to unbind these users from group id "'+e+'"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(o){if(o){$("body").mLoading("show");var a=t.bootgrid("getSelectedRows"),r=[];$.each(a,function(t,o){r.push(Group.deleteMemberFromGroup(e,o))}),$.when.apply(this,r).then(function(){var e=!1,o=[];$.each(r,function(t,a){a.responseJSON.code>="400"&&(e=!0,a.responseJSON.body.hasOwnProperty("exception")&&o.push(a.responseJSON.body.message+". "+a.responseJSON.body.exception+"<br>"))}),e?toastr.error(o):toastr.success("Selected users successfully unbinded from group"),t.bootgrid("reload"),$("body").mLoading("hide")})}}})})});