/**
 * This content is released under the MIT License (MIT)
 *
 * Copyright (c) 2017, canchito-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 * @author 		Jose Carlos Mendoza Prego
 * @copyright	Copyright (c) 2017, canchito-dev (http://www.canchito-dev.com)
 * @license		http://opensource.org/licenses/MIT	MIT License
 * @link		https://github.com/canchito-dev/canchito-workflow-manager
 **/
$(document).ready(function(){Deployment.init(url);var e=$("#deployments-grid-data").bootgrid({url:url+Deployment.getUrl("listOfDeployments"),formatters:{name:function(e,t){return'<button type="button" class="btn btn-link command-details" data-row-id="'+t.id+'">'+t.name+"</button>"}},fieldHandler:function(e){return e.searchPhrase=$('form[name="formFilterDeployment"]').serializeArray(),Deployment.requestFilter(e)},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><button type="button" class="btn btn-dark" id="btnNew" name="btnNew" data-toggle="tooltip" title="New"><i class="fas fa-plus" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnBatchDelete" name="btnBatchDelete" data-toggle="tooltip" title="Delete"><i class="fas fa-trash-alt" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnFilterSearch" name="btnFilterSearch" data-toggle="tooltip" title="Filter"><i class="fas fa-search" aria-hidden="true"></i></button>\x3c!--Your Button goes here--\x3e</div><p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){e.find(".command-details").on("click",function(e){var t=$('form[name="formDeployment"]'),o=$(this).data("row-id");$("#deployments-pills li:first-child a").tab("show"),$("#resources-grid-data").bootgrid("destroy"),Deployment.edit(o,{success:function(e){if(e.code>=400)e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason);else{FormUtil.mapRestVariablesToForm(t,[e.body]),t.find('input[name="deploymentTime"]').val(new Date(e.body.deploymentTime).toLocaleString());var n=$("#resources-grid-data").bootgrid({url:url+Deployment.getUrl("listOfResourcesInDeployment"),formatters:{commands:function(e,t){return'<button type="button" class="btn btn-sm btn-dark command-resource-download" data-row-deployment-id="'+o+'" data-row-resource-id="'+t.id+'" data-toggle="tooltip" title="Download resource"><span class="fas fa-cloud-download-alt"></span></button>'}},fieldHandler:function(e){return e.deploymentId=o,e},responseHandler:function(e){return{total:e.body.length,current:this.orgRequest.current,rowCount:this.orgRequest.rowCount,rows:e.body}},sortable:!1,sorting:!1}).on("loaded.rs.jquery.bootgrid",function(){n.find(".command-resource-download").on("click",function(e){var t=$(this).data("row-resource-id");Deployment.getSingleDeploymentResourceContent($(this).data("row-deployment-id"),t,{success:function(e){if(e.code>=400)e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason);else{var o=new Blob([e.body]),n=document.createElement("a");n.href=window.URL.createObjectURL(o),n.download=t,n.click()}}})})});$("#deployments-pills li:last-child a").removeClass("disabled")}}})})});$('button[name="btnNew"]').on("click",function(){$('input[name="files"]').trigger("click")}),$('button[name="btnFilterSearch"]').on("click",function(){var e=$("#deploymentFilterSeachModal");e.find(".modal-title").text("Filter deployments"),e.modal("show")}),$('button[name="btnBatchDelete"]').on("click",function(){bootbox.confirm({title:"Delete deployments",message:'Do you really want to delete the selected deployments"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(t){if(t){$("body").mLoading("show");var o=e.bootgrid("getSelectedRows"),n=[];$.each(o,function(e,t){n.push(Deployment.erase(t))}),$.when.apply(this,n).then(function(){var t=!1,o=[];$.each(n,function(e,n){n.responseJSON.code>="400"&&(t=!0,n.responseJSON.body.hasOwnProperty("exception")&&o.push(n.responseJSON.body.message+". "+n.responseJSON.body.exception+"<br>"))}),t?toastr.error(o):toastr.success("Selected deployments successfully deleted"),e.bootgrid("reload"),$("body").mLoading("hide")})}}})}),$("#deploymentModal").on("show.bs.modal",function(e){}),$("#deploymentModal").on("hidden.bs.modal",function(e){$('form[name="formDeployment"]').validate().resetForm(),$('form[name="formDeployment"]').trigger("reset"),$('form[name="formDeployment"]').find(".form-control").each(function(){$(this).removeClass("is-invalid")}),$('form[name="formDeployment"]').find('input[name="action"]').val("new")}),$('form[name="formDeployment"]').validate({submitHandler:function(t){$('form[name="formDeployment"]').find('input[name="id"]');Deployment.save($(t).serializeArray(),{complete:function(){$("body").mLoading("hide")},success:function(t){t.code>=400?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success(t.reason),e.bootgrid("reload"),$("#deploymentModal").modal("hide"))}})}}),$('form[name="formFilterDeployment"]').validate({submitHandler:function(t){e.bootgrid("reload"),$("#deploymentFilterSeachModal").modal("hide")}}),$('input[name="files"]').fileupload({url:url+Deployment.getUrl("save"),type:"POST",dataType:"json",autoUpload:!0,acceptFileTypes:/(\.|\/)(xml|zip|bpmn|bpmn20|bar)$/i,limitMultiFileUploadSize:1e6,singleFileUploads:!0,multipart:!0,start:function(e){$("body").mLoading("show")},done:function(t,o){o.result.code>="400"?toastr.error(o.result.body.message+". "+o.result.body.exception):(toastr.success(o.result.reason+". Deployment uploaded"),e.bootgrid("reload"))},fail:function(e,t){toastr.error(t.jqXHR.responseText)},progressall:function(e,t){console.log("Progress all loaded: "+t.loaded+" of total: "+t.total+"("+parseInt(t.loaded/t.total*100,10)+"%)")},stop:function(e){$("body").mLoading("hide")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled")});