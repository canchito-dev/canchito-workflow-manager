/**
 * This content is released under the MIT License (MIT)
 *
 * Copyright (c) 2017, canchito-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 * @author 		Jose Carlos Mendoza Prego
 * @copyright	Copyright (c) 2017, canchito-dev (http://www.canchito-dev.com)
 * @license		http://opensource.org/licenses/MIT	MIT License
 * @link		https://github.com/canchito-dev/canchito-workflow-manager
 **/
$(document).ready(function(){User.init(url);var e=$("#grid-data").bootgrid({url:url+"users/getListOfUsers",formatters:{commands:function(e,t){return'<button type="button" class="btn btn-sm btn-dark command-edit" data-row-id="'+t.id+'" data-toggle="tooltip" title="Edit"><span class="fas fa-edit"></span></button> <button type="button" class="btn btn-sm btn-dark command-delete" data-row-id="'+t.id+'" data-toggle="tooltip" title="Delete"><span class="fas fa-trash-alt"></span></button>'}},fieldHandler:function(e){return User.requestFilter(e)},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><button type="button" class="btn btn-dark" id="btnNew" name="btnNew" data-toggle="tooltip" title="New"><i class="fas fa-plus" aria-hidden="true"></i></button><button type="button" class="btn btn-dark" id="btnBatchDelete" name="btnBatchDelete" data-toggle="tooltip" title="Delete"><i class="fas fa-trash-alt" aria-hidden="true"></i></button></div>\x3c!--Your Button goes here--\x3e<p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){e.find(".command-edit").on("click",function(e){$('form[name="formUser"]').find('input[name="action"]').val("update");var t=$('form[name="formUser"]').find('input[name="id"]');t.addClass("disabled"),t.attr("readonly",!0).attr("disabled",!0),User.edit($(this).data("row-id"),{success:function(e){if(e.code>=400)e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason);else{FormUtil.mapRestVariablesToForm($('form[name="formUser"]'),[e.body]);var t=$('form[name="formUser"]').find('input[name="id"]').val();t=t.split("@",1),$('form[name="formUser"]').find('input[name="id"]').val(t);var a=$("#userModal");a.find(".modal-title").text("Edit user"),a.modal("show")}}})}).end().find(".command-delete").on("click",function(t){var a=$(this).data("row-id");bootbox.confirm({title:"Delete user",message:'Do you really want to delete user with id "'+a+'"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(t){if(t)return User.erase(a,{success:function(t){t.code>="400"?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success("User successfully deleted"),e.bootgrid("reload"))}})}})})});$('button[name="btnNew"]').on("click",function(){$('form[name="formUser"]').find('input[name="action"]').val("new");var e=$("#userModal");e.find(".modal-title").text("New user"),e.modal("show")}),$('button[name="btnBatchDelete"]').on("click",function(){bootbox.confirm({title:"Delete users",message:'Do you really want to delete the selected users"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(t){if(t){$("body").mLoading("show");var a=e.bootgrid("getSelectedRows"),o=[];$.each(a,function(e,t){o.push(User.erase(t))}),$.when.apply(this,o).then(function(){var t=!1,a=[];$.each(o,function(e,o){o.responseJSON.code>="400"&&(t=!0,o.responseJSON.body.hasOwnProperty("exception")&&a.push(o.responseJSON.body.message+". "+o.responseJSON.body.exception+"<br>"))}),t?toastr.error(a):toastr.success("Selected users successfully deleted"),e.bootgrid("reload"),$("body").mLoading("hide")})}}})}),$("#userModal").on("hidden.bs.modal",function(e){$('form[name="formUser"]').validate().resetForm(),$('form[name="formUser"]').trigger("reset"),$('form[name="formUser"]').find(".form-control").each(function(){$(this).removeClass("is-invalid")}),$('form[name="formUser"]').find('input[name="action"]').val("new");var t=$('form[name="formUser"]').find('input[name="id"]');t.removeClass("disabled"),t.attr("readonly",!1).attr("disabled",!1)}),$('form[name="formUser"]').validate({rules:{confirmPassword:{equalTo:"#password"}},submitHandler:function(t){var a=$('form[name="formUser"]').find('input[name="id"]');a.removeClass("disabled"),a.attr("readonly",!1).attr("disabled",!1),User.save($(t).serializeArray(),{complete:function(){if("update"==$('form[name="formUser"]').find('input[name="action"]').val()){var e=$('form[name="formUser"]').find('input[name="id"]');e.addClass("disabled"),e.attr("readonly",!0).attr("disabled",!0)}$("body").mLoading("hide")},success:function(t){t.code>=400?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success(t.reason),e.bootgrid("reload"),$("#userModal").modal("hide"))}})}})});