/**
 * This content is released under the MIT License (MIT)
 *
 * Copyright (c) 2017, canchito-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 * @author 		Jose Carlos Mendoza Prego
 * @copyright	Copyright (c) 2017, canchito-dev (http://www.canchito-dev.com)
 * @license		http://opensource.org/licenses/MIT	MIT License
 * @link		https://github.com/canchito-dev/canchito-workflow-manager
 **/
$(document).ready(function(){ProcessDefinition.init(url),Group.init(url),User.init(url),ProcessInstance.init(url);var e=$("#process-definitions-grid-data").bootgrid({url:url+ProcessDefinition.getUrl("listOfProcessDefinitions"),formatters:{name:function(e,t){return'<button type="button" class="btn btn-link command-details" data-row-id="'+t.id+'">'+t.name+" (v"+t.version+")</button>"}},fieldHandler:function(e){return e.searchPhrase=$('form[name="formFilterProcessDefinition"]').serializeArray(),ProcessDefinition.requestFilter(e)},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><button type="button" class="btn btn-dark" id="btnFilterSearch" name="btnFilterSearch" data-toggle="tooltip" title="Filter"><i class="fas fa-search" aria-hidden="true"></i></button>\x3c!--Your Button goes here--\x3e</div><p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){e.find(".command-details").on("click",function(e){var r=$('form[name="formProcessDefinition"]'),o=$(this).data("row-id");$('div[name="bpmnModel"]').html(""),$("#process-pills-tab li:first-child a").tab("show"),$("#process-pills-tab a:eq(1)").removeClass("disabled"),ProcessDefinition.edit(o,{success:function(e){if(e.code>=400)e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason);else{FormUtil.mapRestVariablesToForm(r,[e.body]);var s=JSON.parse('{"processDefinitionId":"'+o+'"}');_showProcessDiagram(s),t.bootgrid("reload")}}})})});$('button[name="btnFilterSearch"]').on("click",function(){var e=$("#processDefinitionFilterSeachModal");e.find(".modal-title").text("Filter process definitions"),e.modal("show")}),$('form[name="formFilterProcessDefinition"]').validate({submitHandler:function(t){e.bootgrid("reload"),$("#processDefinitionFilterSeachModal").modal("hide")}}),$('form[name="formProcessDefinition"]').validate({submitHandler:function(t){ProcessDefinition.updateCategory($(t).serializeArray(),{success:function(t){t.code>=400?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):(toastr.success(t.reason),e.bootgrid("reload"))}})}});var t=$("#candidate-starters-grid-data").bootgrid({url:url+ProcessDefinition.getUrl("getAllCandidateStarters"),rowCount:[5,10,25,50,-1],formatters:{name:function(e,t){return null==t.user?t.group:t.user},family:function(e,t){return null==t.user?"group":"user"},commands:function(e,t){return'<button type="button" class="btn btn-sm btn-dark command-delete-candidate-starter" data-user-id="'+t.user+'" data-group-id="'+t.group+'" data-toggle="tooltip" title="Delete"><span class="fas fa-trash-alt"></span></button>'}},fieldHandler:function(e){var t=$('form[name="formProcessDefinition"]').find('input[name="id"]').val();return""!=t&&void 0!=t&&(e.id=t),e},responseHandler:function(e){return{total:e.body.length,current:this.orgRequest.current,rowCount:this.orgRequest.rowCount,rows:e.body}},templates:{header:'<div id="{{ctx.id}}" class="{{css.header}}"><div class="row"><div class="col-sm-12 actionBar">\x3c!--Your Button goes here--\x3e<div class="btn-group mr-4" role="group" aria-label="..."><select id="addCandidateStarterUser" name="addCandidateStarterUser" placeholder="Add a user"></select><button type="button" class="btn btn-dark" id="btnAddUser" name="btnAddUser" data-toggle="tooltip" title="Add user"><i class="fas fa-plus" aria-hidden="true"></i></button></div><div class="btn-group mr-4" role="group" aria-label="..."><select id="addCandidateStarterGroup" name="addCandidateStarterGroup" placeholder="Add a group"></select><button type="button" class="btn btn-dark" id="btnAddGroup" name="btnAddGroup" data-toggle="tooltip" title="Add group"><i class="fas fa-plus" aria-hidden="true"></i></button></div>\x3c!--Your Button goes here--\x3e<p class="{{css.search}}"></p><p class="{{css.actions}}"></p></div></div></div>',search:'<div class="{{css.search}} d-none"><div class="input-group"><span class="input-group-addon"><i class="{{css.icon}} {{css.iconSearch}}"></i></span> <input type="text" class="{{css.searchField}}" placeholder="{{lbl.search}}" /></div></div>'}}).on("loaded.rs.jquery.bootgrid",function(){t.find(".command-delete-candidate-starter").on("click",function(e){var r=$(this).data("user-id"),o=$(this).data("group-id"),s=$('form[name="formProcessDefinition"]').find('input[name="id"]').val(),a=null==r?o:r,n=null==r?"groups":"users";bootbox.confirm({title:"Remove candidate starter",message:'Do you really want to candidate starter with id "'+a+'" from process definition "'+s+'"?',buttons:{confirm:{label:"Yes",className:"btn-danger"},cancel:{label:"No",className:"btn-default"}},callback:function(e){if(e)return ProcessDefinition.deleteCandidateStarter(s,n,a,{success:function(e){e.code>="400"?(e.body.hasOwnProperty("exception")&&(e.reason=e.body.message+". "+e.body.exception),toastr.error(e.reason)):(toastr.success("Candidate starter successfully removed"),t.bootgrid("reload"))}})}})})});$('select[name="addCandidateStarterUser"]').selectize({valueField:"id",labelField:"firstName",searchField:"firstName",sortField:"firstName",inputClass:"selectize-form-control selectize-input",dropdownParent:"body",options:[],create:!1,persist:!1,loadThrottle:null,preload:!1,hideSelected:!0,render:{option:function(e,t){return'<option value="'+e.userId+'" data-data="'+JSON.stringify(e)+'">'+e.firstName+" "+e.lastName+"</option>"},item:function(e,t){return"<div>"+e.firstName+" "+e.lastName+"</div>"}},load:function(e,t){if(!e.length)return t();Ajax.executeAjax(url+User.getUrl("listOfUsers"),{firstNameLike:"%"+e+"%"},{type:"POST",dataType:"json",error:function(e){toastr.error("Could not load users"),console.log(e)},success:function(e){if(e.code>="400")return toastr.error("Could not load users"),!1;t(e.body.data.slice(0,15))}})},onChange:function(e){""==e&&void 0==e&&null==e||$('button[name="btnAddUser"]').data("user-id",e)}}),$('select[name="addCandidateStarterGroup"]').selectize({valueField:"id",labelField:"name",searchField:"name",sortField:"name",inputClass:"selectize-form-control selectize-input",dropdownParent:"body",options:[],create:!1,persist:!1,loadThrottle:null,preload:!1,hideSelected:!0,render:{option:function(e,t){return'<option value="'+e.groupId+'" data-data="'+JSON.stringify(e)+'">'+e.name+"</option>"},item:function(e,t){return"<div>"+e.name+"</div>"}},load:function(e,t){if(!e.length)return t();Ajax.executeAjax(url+Group.getUrl("listOfGroups"),{nameLike:"%"+e+"%"},{type:"POST",dataType:"json",error:function(e){toastr.error("Could not load groups"),console.log(e)},success:function(e){if(e.code>="400")return toastr.error("Could not load groups"),!1;t(e.body.data.slice(0,15))}})},onChange:function(e){""==e&&void 0==e&&null==e||$('button[name="btnAddGroup"]').data("group-id",e)}}),$('button[name="btnAddUser"]').bind("click",function(){var e=$(this),r=$('form[name="formProcessDefinition"]').find('input[name="id"]').val(),o=e.data("user-id");ProcessDefinition.addCandidateStarter(r,"user",o,{success:function(o){o.code>="400"?(o.body.hasOwnProperty("exception")&&(o.reason=o.body.message+". "+o.body.exception),toastr.error(o.reason)):(toastr.success('User successfully set as candidate starter for process definition with id "'+r+'"'),t.bootgrid("reload"),e.removeData("user-id"),$('select[name="addCandidateStarterUser"]')[0].selectize.clear(!0))}})}),$('button[name="btnAddGroup"]').bind("click",function(){var e=$(this),r=$('form[name="formProcessDefinition"]').find('input[name="id"]').val(),o=e.data("group-id");ProcessDefinition.addCandidateStarter(r,"group",o,{success:function(o){o.code>="400"?(o.body.hasOwnProperty("exception")&&(o.reason=o.body.message+". "+o.body.exception),toastr.error(o.reason)):(toastr.success('Group successfully set as candidate starter for process definition with id "'+r+'"'),t.bootgrid("reload"),e.removeData("group-id"),$('select[name="addCandidateStarterGroup"]')[0].selectize.clear(!0))}})}),$('button[name="btnStartProcessInstance"]').on("click",function(){var e=$('form[name="formProcessDefinition"]').find('input[name="id"]').val();ProcessInstance.startProcessInstance({processDefinitionId:e},{success:function(t){t.code>="400"?(t.body.hasOwnProperty("exception")&&(t.reason=t.body.message+". "+t.body.exception),toastr.error(t.reason)):toastr.success('Process instance for process definition with id "'+e+'" successfully started')}})})});